import time
import requests
from VIPMUSIC import app
from config import BANNED_USERS
from pyrogram.enums import ChatAction, ParseMode
from pyrogram import filters
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton, InputMediaPhoto

# API URLs
CHAT_API_URL = "https://chatgpt.apinepdev.workers.dev/?question="
IMAGE_API_URL = "https://pollinations.ai/p/" # Best for high quality images

# --- CHATGPT COMMAND ---
@app.on_message(filters.command(["chatgpt", "ai", "ask", "gpt", "solve"], prefixes=["+", ".", "/", "-", "", "$", "#", "&"]) & ~BANNED_USERS)
async def chat_gpt(bot, message):
    try:
        await bot.send_chat_action(message.chat.id, ChatAction.TYPING)

        if len(message.command) < 2:
            return await message.reply_text(
                "**Usage:**\n`/chatgpt Where is the Taj Mahal?`",
                parse_mode=ParseMode.MARKDOWN
            )

        question = message.text.split(' ', 1)[1]
        response = requests.get(f"{CHAT_API_URL}{question}")

        if response.status_code == 200:
            json_data = response.json()
            if "answer" in json_data:
                answer = json_data["answer"]
                
                # Cleaning unwanted links/ads
                unwanted_phrases = ["ðŸ”— Join our community", "t.me/", "Answered by", "Join our Telegram"]
                for phrase in unwanted_phrases:
                    if phrase.lower() in answer.lower():
                        answer = answer.split(phrase)[0].strip()

                buttons = InlineKeyboardMarkup([[InlineKeyboardButton("âœ™ ÊŒá´…á´… Ï»Ñ” ÉªÎ· ÊÏƒÏ…Ê€ É¢Ê€ÏƒÏ…á´˜ âœ™", url=f"https://t.me/{app.username}?startgroup=true")]])

                return await message.reply_text(
                    f"**ðŸ¤– ð€Éª ð‘á´‡sá´˜á´É´sá´‡ :**\n\n{answer}",
                    parse_mode=ParseMode.MARKDOWN,
                    reply_markup=buttons
                )
        await message.reply_text("âš ï¸ API error or no response.")
    except Exception as e:
        await message.reply_text(f"âš ï¸ **Error:** `{str(e)}`")

# --- IMAGE GENERATION COMMAND ---
@app.on_message(filters.command(["generate", "draw", "imagine", "photo", "art"], prefixes=["+", ".", "/", "-", "", "$", "#", "&"]) & ~BANNED_USERS)
async def generate_image(bot, message):
    try:
        if len(message.command) < 2:
            return await message.reply_text(
                "**Usage:**\n`/generate a blue lion in space` \n(Aap color aur style specify kar sakte hain)"
            )

        prompt = message.text.split(None, 1)[1]
        wait_msg = await message.reply_text("ðŸŽ¨ **Wait... Generating your imagination...**")
        
        await bot.send_chat_action(message.chat.id, ChatAction.UPLOAD_PHOTO)

        # Pollinations API handles colors and descriptions automatically in the URL
        # We encode spaces to %20 for the URL
        image_url = f"{IMAGE_API_URL}{prompt.replace(' ', '%20')}?width=1080&height=1080&seed=42&model=flux"

        # Sending the photo
        await message.reply_photo(
            photo=image_url,
            caption=f"**âœ¨ Prompt:** {prompt}\n\n**Generated by:** @{app.username}",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("âœ™ ÊŒá´…á´… Ï»Ñ” ÉªÎ· ÊÏƒÏ…Ê€ É¢Ê€ÏƒÏ…á´˜ âœ™", url=f"https://t.me/{app.username}?startgroup=true")]])
        )
        await wait_msg.delete()

    except Exception as e:
        await message.reply_text(f"âŒ **Failed to generate image.**\n`{str(e)}`")

__MODULE__ = "AÉª-CÊœá´€á´›"
__HELP__ = """
**AI & ChatGPT Commands:**
/ai [Ç«á´œá´‡Ê€Ê] - á´€sá´‹ Êá´á´œÊ€ Ç«á´œá´‡sá´›Éªá´É´ á´¡Éªá´›Êœ á´„Êœá´€á´›É¢á´˜á´›
/ask [Ç«á´œá´‡Ê€Ê] - á´€sá´‹ á´€É´Êá´›ÊœÉªÉ´É¢ á´›á´ á´›Êœá´‡ Ê™á´á´›

**Photo Generation Commands:**
/generate [á´˜Ê€á´á´á´˜á´›] - á´„Ê€á´‡á´€á´›á´‡ AI Éªá´á´€É¢á´‡s (á´‡.É¢. /generate red car in rain)
/draw [á´˜Ê€á´á´á´˜á´›] - á´…Ê€á´€á´¡ Êá´á´œÊ€ Éªá´á´€É¢ÉªÉ´á´€á´›Éªá´É´ ÉªÉ´ á´…ÉªÒ“Ò“á´‡Ê€á´‡É´á´› á´„á´ÊŸá´Ê€s
/imagine [á´˜Ê€á´á´á´˜á´›] - ÊœÉªÉ¢Êœ Ç«á´œá´€ÊŸÉªá´›Ê AI á´€Ê€á´› É¢á´‡É´á´‡Ê€á´€á´›á´Ê€
"""
